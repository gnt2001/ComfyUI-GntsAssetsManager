<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ComfyUI Assets Manager</title>
    <style>
        :root { --bg: #1e1e1e; --header: #2d2d2d; --accent: #0e639c; --border: #3c3c3c; --text: #cccccc; }
        body { margin: 0; font-family: "Segoe UI", sans-serif; height: 100vh; display: flex; flex-direction: column; background: var(--bg); color: var(--text); overflow: hidden; }
        
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(3px);
            display: none; z-index: 9999; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid #4fc1ff;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #imageViewer {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 10000; cursor: zoom-out;
            justify-content: center; align-items: center;
        }
        #imageViewer img { max-width: 95%; max-height: 95%; object-fit: contain; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

        .top-bar { 
            display: flex; align-items: center; justify-content: space-between;
            background: var(--header); padding: 0 15px; height: 40px;
            border-bottom: 1px solid var(--border); z-index: 100;
        }

        .nav-group { display: flex; gap: 2px; height: 100%; align-items: flex-end; }
        .tab-btn { 
            padding: 8px 16px; border: none; background: transparent; color: #888; 
            cursor: pointer; font-size: 14px; border-radius: 8px 8px 0 0; transition: 0.2s;
        }
        .tab-btn.active { background: var(--bg); color: #4fc1ff; font-weight: bold; }
        .tab-btn:hover:not(.active) { background: #333; }

        .status-center { 
            font-family: monospace; font-size: 12px; color: #4fc1ff; 
            background: #1a1a1a; padding: 4px 18px; border-radius: 12px; 
            border: 1px solid #444; min-width: 140px; text-align: center;
            user-select: none;
        }

        .action-group { display: flex; gap: 8px; }

        .main-container { flex: 1; display: flex; overflow: hidden; }
        .view-section { display: none; width: 100%; height: 100%; }
        .view-section.active { display: flex; }

        .sidebar { width: 300px; background: #252526; border-right: 1px solid var(--border); overflow-y: auto; }
        .file-item { padding: 10px 15px; border-bottom: 1px solid #303030; cursor: pointer; font-size: 12px; word-break: break-all; }
        .file-item:hover { background: #37373d; }
        .file-item.active { background: #094771; color: white; }
        
        .video-player-container { flex: 1; display: flex; justify-content: center; align-items: center; background: #000; padding: 20px; }
        video { max-width: 100%; max-height: 100%; border-radius: 4px; }

        .img-grid { 
            flex: 1; overflow-y: auto; display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 15px; padding: 15px; align-content: start;
            border: 2px dashed transparent; transition: 0.3s;
        }
        .img-grid.dragover { border: 2px dashed #4fc1ff; background: rgba(79, 193, 255, 0.05); }

        .img-card { 
            background: #111; border-radius: 4px; overflow: hidden; 
            border: 2px solid transparent; display: flex; flex-direction: column; 
            transition: border 0.1s; min-height: 240px;
        }
        .img-card img { width: 100%; height: 210px; object-fit: contain; background: #000; cursor: pointer; flex-shrink: 0; }
        .img-card.selected { border: 2px solid #4fc1ff !important; background: #222; }
        .img-card.selected img { opacity: 0.4; }
        
        .img-name { 
            font-size: 10px;padding:0px 6px; text-align: center; color: #4fc1ff; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            cursor: pointer; background: #222; flex-shrink: 0; height: 30px; line-height: 30px;
        }
        .img-name:hover { color: white; background: #333; }

        .btn { border: none; padding: 5px 12px; border-radius: 3px; cursor: pointer; font-size: 12px; color: white; opacity: 0.9; }
        .btn-red { background: #a94442; }
        .btn-gray { background: #444; }

        #v-actions, #i-actions { display: none; gap: 8px; }
        #btn-clear-all, #btn-del-others { display: none; margin-right: 5px; }
        #v-actions:hover #btn-clear-all, #v-actions:hover #btn-del-others { display: inline-block; }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p id="loadingText" style="color: #4fc1ff; margin-top: 15px; font-size: 14px; font-family: monospace;">Syncing Data...</p>
    </div>

    <div id="imageViewer" onclick="closeViewer()">
        <img id="viewerImg" src="">
    </div>

    <div class="top-bar">
        <div class="nav-group">
            <button id="tab-output" class="tab-btn" onclick="handleTabClick('output')">OUTPUT (Videos)</button>
            <button id="tab-input" class="tab-btn" onclick="handleTabClick('input')">INPUT (Images)</button>
        </div>

        <div class="status-center">
            <span id="status-video" style="display: none;">Total videos: 0</span>
            <span id="status-image" style="display: none;">Selected: 0 / Total images: 0</span>
        </div>

        <div class="action-group">
            <div id="v-actions">
                <button id="btn-clear-all" class="btn btn-red" onclick="clearAllVideos()">Delete All</button>
                <button id="btn-del-others" class="btn btn-red" onclick="deleteOtherVideos()">Delete Others</button>
                <button id="btn-del-current" class="btn btn-red" onclick="deleteCurrentVideo()">Delete</button>
            </div>
            <div id="i-actions">
                <button class="btn btn-gray" onclick="toggleAllImages()">Invert Selection</button>
                <button class="btn btn-gray" onclick="clearImageSelection()">Clear Selection</button>
                <button class="btn btn-red" onclick="deleteSelectedImages()">Delete</button>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div id="view-output" class="view-section">
            <div class="sidebar" id="videoList"></div>
            <div class="video-player-container">
                <video id="videoPlayer" controls loop muted style="display:none;"></video>
                <div id="v-placeholder">No videos yet</div>
            </div>
        </div>

        <div id="view-input" class="view-section">
            <div class="img-grid" id="imageGrid"></div>
        </div>
    </div>

    <script>
        let currentTab = '';
        let currentVideo = "";
        let selectedImages = new Set(); 

        function setLoading(active, text = "Syncing Data...") {
            document.getElementById('loadingText').innerText = text;
            document.getElementById('loadingOverlay').style.display = active ? 'flex' : 'none';
        }

        function handleTabClick(tab) {
            if (currentTab === tab) { manualRefresh(); } else { switchTab(tab); }
        }

        async function manualRefresh() {
            setLoading(true);
            try {
                if (currentTab === 'output') { await loadVideos(); } else { await loadImages(); }
            } finally { setLoading(false); }
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.id === `tab-${tab}`));
            document.querySelectorAll('.view-section').forEach(s => s.classList.toggle('active', s.id === `view-${tab}`));
            document.getElementById('v-actions').style.display = (tab === 'output') ? 'flex' : 'none';
            document.getElementById('i-actions').style.display = (tab === 'input') ? 'flex' : 'none';
            document.getElementById('status-video').style.display = (tab === 'output') ? 'inline' : 'none';
            document.getElementById('status-image').style.display = (tab === 'input') ? 'inline' : 'none';
        }

        // --- Video logic ---
        async function loadVideos() {
            const res = await fetch('/gnts-assets-manager/output/list'); 
            window.videoData = await res.json(); 
            renderVideoList();
        }

        function renderVideoList() {
            const files = window.videoData || [];
            const list = document.getElementById('videoList');
            list.innerHTML = files.map(f => `
                <div class="file-item ${f === currentVideo ? 'active' : ''}" onclick="playVideo('${f}')">
                    ${f}
                </div>
            `).join('');
            
            if (files.length > 0) {
                if (!currentVideo || !files.includes(currentVideo)) {
                    playVideo(files[0]);
                } else {
                    playVideo(currentVideo);
                }
            } else {
                playVideo(null);
            }
            updateVideoStatus();
        }

        function updateVideoStatus() {
            const count = (window.videoData || []).length;
            document.getElementById('status-video').innerText = `Total videos: ${count}`;
        }

        function playVideo(filename) {
            const player = document.getElementById('videoPlayer');
            const placeholder = document.getElementById('v-placeholder');
            if (!filename) {
                currentVideo = "";
                player.style.display = 'none';
                player.src = "";
                placeholder.style.display = 'block';
                document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
                return;
            }
            currentVideo = filename;
            player.style.display = 'block';
            placeholder.style.display = 'none';
            const newSrc = `/gnts-assets-manager/output/view/${encodeURIComponent(filename)}`; 
            if (!player.src.endsWith(newSrc)) {
                player.src = newSrc;
                player.play().catch(e => console.log("Auto-play blocked or failed"));
            }
            document.querySelectorAll('.file-item').forEach(el => {
                el.classList.toggle('active', el.innerText.trim() === filename);
            });
        }

        async function deleteCurrentVideo() {
            if(!currentVideo || !confirm('Are you sure you want to permanently delete this video?')) return;
            const currentIndex = window.videoData.indexOf(currentVideo);
            setLoading(true);
            try {
                await fetch(`/gnts-assets-manager/output/delete/${encodeURIComponent(currentVideo)}`, {method:'DELETE'});
                const res = await fetch('/gnts-assets-manager/output/list');
                window.videoData = await res.json();
                const files = window.videoData;
                if (files.length > 0) {
                    const nextIndex = currentIndex < files.length ? currentIndex : files.length - 1;
                    currentVideo = files[nextIndex];
                } else { currentVideo = ""; }
                renderVideoList(); 
            } finally { setLoading(false); }
        }

        async function deleteOtherVideos() {
            if(!currentVideo) { alert('Please select a video to keep first'); return; }
            if(!confirm(`Are you sure you want to delete all videos except "${currentVideo}"?`)) return;
            setLoading(true);
            try {
                await fetch(`/gnts-assets-manager/output/delete_others/${encodeURIComponent(currentVideo)}`, {method:'DELETE'});
                await loadVideos();
            } finally { setLoading(false); }
        }

        async function clearAllVideos() {
            if(!confirm('Are you sure you want to delete all output videos?')) return;
            setLoading(true);
            try {
                await fetch('/gnts-assets-manager/output/delete_all', {method:'DELETE'});
                currentVideo = "";
                document.getElementById('videoPlayer').style.display = 'none';
                await loadVideos();
            } finally { setLoading(false); }
        }

        // --- Image logic ---
        async function loadImages() {
            const res = await fetch('/gnts-assets-manager/input/list'); 
            const images = await res.json();
            window.imageData = images;
            const serverImageSet = new Set(images);
            selectedImages.forEach(name => {
                if (!serverImageSet.has(name)) selectedImages.delete(name);
            });
            renderImageGrid();
        }

        function renderImageGrid() {
            const grid = document.getElementById('imageGrid');
            const images = window.imageData || [];
            grid.innerHTML = images.map(img => `
                <div class="img-card ${selectedImages.has(img) ? 'selected' : ''}">
                    <img src="/gnts-assets-manager/input/view/${encodeURIComponent(img)}" loading="lazy" onclick="viewFullImage('${img}')">
                    <div class="img-name" onclick="toggleImageSelection(this.parentElement, '${img}')">${img}</div>
                </div>
            `).join('');
            updateImgCount();
        }

        function toggleImageSelection(el, filename) {
            if (selectedImages.has(filename)) {
                selectedImages.delete(filename);
                el.classList.remove('selected');
            } else {
                selectedImages.add(filename);
                el.classList.add('selected');
            }
            updateImgCount();
        }

        function toggleAllImages() {
            const images = window.imageData || [];
            images.forEach(img => {
                if (selectedImages.has(img)) { selectedImages.delete(img); } 
                else { selectedImages.add(img); }
            });
            renderImageGrid();
        }

        function viewFullImage(filename) {
            const viewer = document.getElementById('imageViewer');
            const viewerImg = document.getElementById('viewerImg');
            viewerImg.src = `/gnts-assets-manager/input/view/${encodeURIComponent(filename)}`;
            viewer.style.display = 'flex';
        }

        function closeViewer() { document.getElementById('imageViewer').style.display = 'none'; }

        function updateImgCount() {
            const total = (window.imageData || []).length;
            const selected = selectedImages.size;
            document.getElementById('status-image').innerText = `Selected: ${selected} / Total images: ${total}`;
        }

        function clearImageSelection() { selectedImages.clear(); renderImageGrid(); }

        async function deleteSelectedImages() {
            const selectedArray = Array.from(selectedImages);
            if(!selectedArray.length || !confirm(`Are you sure you want to delete the selected ${selectedArray.length} image(s)?`)) return;
            setLoading(true);
            try {
                await fetch('/gnts-assets-manager/input/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({filenames: selectedArray})
                });
                selectedImages.clear();
                await loadImages();
            } finally { setLoading(false); }
        }

        // --- Drag & Drop ---
        const grid = document.getElementById('imageGrid');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            grid.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
        });
        grid.addEventListener('dragover', () => grid.classList.add('dragover'));
        grid.addEventListener('dragleave', () => grid.classList.remove('dragover'));
        grid.addEventListener('drop', async (e) => {
            grid.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
            if (files.length === 0) return;
            setLoading(true, `Uploading ${files.length} image(s)...`);
            const formData = new FormData();
            files.forEach(file => formData.append('files', file));
            try {
                await fetch('/gnts-assets-manager/input/upload', { method: 'POST', body: formData });
                await loadImages();
            } catch (err) { alert('Upload failed'); } finally { setLoading(false); }
        });

        // --- Page load ---
        window.onload = async () => {
            switchTab('output'); 
            setLoading(true);
            try { await Promise.all([loadVideos(), loadImages()]); } 
            finally { setLoading(false); }
        };
    </script>
</body>
</html>